<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    <title>railmap.png-1665619169705.jpg</title>
    <meta http-equiv='imagetoolbar' content='no'/>
    <style type="text/css"> v\:* {behavior:url(#default#VML);}
        html, body { overflow: hidden; padding: 0; height: 100%; width: 100%; font-family: 'Lucida Grande',Geneva,Arial,Verdana,sans-serif; }
        body { margin: 10px; background: #fff; }
        h1 { margin: 0; padding: 6px; border:0; font-size: 20pt; }
        #header { height: 43px; padding: 0; background-color: #eee; border: 1px solid #888; }
        #subheader { height: 12px; text-align: right; font-size: 10px; color: #555;}
        #map { height: 90%; border: 1px solid #888; }
    </style>
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">-->
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.css" type="text/css">
    <script src="https://unpkg.com/ol-popup@5.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/ol-popup@5.0.0/src/ol-popup.css" />
    <script src="https://unpkg.com/ol-layerswitcher@4.1.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@4.1.0/dist/ol-layerswitcher.css" />
    </head>
<body>
    <div id="header"><h1>railmap.png-1665619169705.jpg</h1></div>
    <div id="subheader">Generated by <a href="https://gdal.org/programs/gdal2tiles.html">GDAL2Tiles</a>&nbsp;&nbsp;&nbsp;&nbsp;</div>
    <div id="map" class="map">
    </div>
    <div id="mouse-position"></div>
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>-->

    <script type="text/javascript">
        var mousePositionControl = new ol.control.MousePosition({
            className: 'custom-mouse-position',
            target: document.getElementById('mouse-position'),
            undefinedHTML: '&nbsp;'
        });
        var map = new ol.Map({
            controls: ol.control.defaults.defaults().extend([mousePositionControl]),
            target: 'map',
            layers: [
                new ol.layer.Group({
                    // title: 'Map',
                    // combine: true,
                    layers: [
                        new ol.layer.Tile({
                            title: 'Map',
                            type: 'base',
                            // opacity: 0.7,
                            source: new ol.source.TileImage({
                                attributions: '',
                                tileGrid: new ol.tilegrid.TileGrid({
                                    extent: [0,-6217,5645,0],
                                    origin: [0,-6217],
                                    resolutions: [32,16,8,4,2,1],
                                    tileSize: [256, 256]
                                }),
                                tileUrlFunction: function(tileCoord) {
                                    return ('/uploads/{z}/{x}/{y}.webp'
                                        .replace('{z}', String(tileCoord[0]))
                                        .replace('{x}', String(tileCoord[1]))
                                        .replace('{y}', String(- 1 - tileCoord[2])));
                                },
                            })
                        }),
                    ]
                }),
            ],
            view: new ol.View({
                center: [2822.500000, -2108.500000],
                resolution: 4.000000,
            })
        });

        //
        // add lines
        //

        const geoJson = new ol.format.GeoJSON();
        let col = geoJson.readFeatures({"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[2177.5844952474167,-601.0173296242892],[2291.209410513108,-631.2562183643524],[2357.1851677641553,-724.721874470002],[2416.7466152824613,-830.099820079313],[2408.4996456260806,-987.7085735123692],[2441.487524251604,-1009.7004925960515],[2397.5036860842392,-1043.604701183395],[2334.276918718653,-1160.8949362963672],[2475.3917328389475,-1177.3888756091287],[2497.3836519226297,-1170.9745658763882],[2497.3836519226297,-1204.8787744637316],[2589.016648104639,-1225.954363585594],[2585.3513282573585,-1269.9382017529583],[2562.4430792118565,-1338.6629488894655],[2558.777759364576,-1416.5509956441736],[2589.016648104639,-1439.4592446896759]]},"properties":{clan:'BigOof'}}]})
        const collection = new ol.Collection(col);
        const clanGroup = new ol.layer.Group({
          title: 'Train Lines',
        });
        map.addLayer(clanGroup);

        let draw = null, snap = null

        collection.on('add', (e) => {
          console.log('add', e)
          e.element.set('clan', 'unknown');
          // e.element.setStyle(new ol.style.Style({
          //   stroke: new ol.style.Stroke({
          //     color: "#731422",
          //     width: 3,
          //   })}));
          console.log(geoJson.writeFeatures(collection.getArray()))
        })
        collection.on('change', (e) => {
          console.log('change', e)
          console.log(geoJson.writeFeatures(collection.getArray()))
        })

        var sourceLine = new ol.source.Vector({
          features: collection,
        });

        var vectorLine = new ol.layer.Vector({
          source: sourceLine,
          title: 'BigOof',
          style: (feature,zoom) => {
            return new ol.style.Style({
              stroke: new ol.style.Stroke({
                  color: "#4e6fe5",
                  width: 5,
                })
            })
          }
        });
        clanGroup.getLayers().push(vectorLine);

        //
        // controls
        //

        var button = document.createElement('button');
        button.innerHTML = 'L';

        var handleLine = function(e) {
          if (draw === null) {
            draw = new ol.interaction.Draw({
              // source: source,
              type: 'LineString',
              features: collection,
              stopClick: true,
            });
            map.addInteraction(draw);
            snap = new ol.interaction.Snap({features: collection});
            map.addInteraction(snap);
          }
          else {
            map.removeInteraction(draw)
            map.removeInteraction(snap)
          }
        };

        button.addEventListener('click', handleLine, false);

        var element = document.createElement('div');
        element.className = 'ol-unselectable ol-control';
        element.appendChild(button);
        element.style.left = '0.5em';
        element.style.top = '6.5em';

        var lineDraw = new ol.control.Control({
          element: element
        });
        map.addControl(lineDraw);

        //
        // modify
        //

        const select = new ol.interaction.Select({
          wrapX: false,
        });

        const modify = new ol.interaction.Modify({
          features: select.getFeatures(),
        });

        map.addInteraction(select)
        map.addInteraction(modify)

        //
        // Icon Warning
        //
        const iconStyle = new ol.style.Style({
          image: new ol.style.Icon({
            anchor: [0.5, 46],
            anchorXUnits: 'fraction',
            anchorYUnits: 'pixels',
            src: 'uploads/warning.png',
            // size: [32,32],
            // offset: 10,
            // scale: [32,32]
          }),
        });
        const iconCollection = new ol.Collection([]);
        var iconSourceLine = new ol.source.Vector({
          features: iconCollection,
        });

        var iconVectorLine = new ol.layer.Vector({
          source: iconSourceLine,
          title: 'Warnings',
          style: (feat, zoom) => {
            // iconStyle.scale = Math.min(0.0625 * zoom, 0.0625)
            console.log(iconStyle)
            return iconStyle
          },
        });
        map.addLayer(iconVectorLine);

        var iconButton = document.createElement('button');
        iconButton.innerHTML = 'W';

        var handleIcon = function(e) {
          if (draw === null) {
            draw = new ol.interaction.Draw({
              // source: source,
              type: 'Point',
              features: iconCollection,
              // stopClick: true,
            });
            map.addInteraction(draw);
          }
          else {
            map.removeInteraction(draw)
          }
        };

        iconButton.addEventListener('click', handleIcon, false);

        var iconElement = document.createElement('div');
        iconElement.className = 'ol-unselectable ol-control';
        iconElement.appendChild(iconButton);
        iconElement.style.left = '0.5em';
        iconElement.style.top = '3.5em';

        var iconDraw = new ol.control.Control({
          element: iconElement
        });
        map.addControl(iconDraw);

        //
        // Icon Alert
        //
        const iconAlertStyle = new ol.style.Style({
          image: new ol.style.Icon({
            anchor: [0.5, 46],
            anchorXUnits: 'fraction',
            anchorYUnits: 'pixels',
            src: 'uploads/alert.png',
            // size: [32,32],
            // offset: 10,
            // scale: [32,32]
          }),
        });
        const iconAlertCollection = new ol.Collection([]);
        var iconAlertSourceLine = new ol.source.Vector({
          features: iconAlertCollection,
        });

        var iconAlertVectorLine = new ol.layer.Vector({
          source: iconAlertSourceLine,
          title: 'Alert',
          style: (feat, zoom) => {
            // iconStyle.scale = Math.min(0.0625 * zoom, 0.0625)
            console.log(iconAlertStyle)
            return iconAlertStyle
          },
        });
        map.addLayer(iconAlertVectorLine);

        var iconAlertButton = document.createElement('button');
        iconAlertButton.innerHTML = 'A';

        var handleIcon = function(e) {
          if (draw === null) {
            draw = new ol.interaction.Draw({
              // source: source,
              type: 'Point',
              features: iconAlertCollection,
              // stopClick: true,
            });
            map.addInteraction(draw);
          }
          else {
            map.removeInteraction(draw)
          }
        };

        iconAlertButton.addEventListener('click', handleIcon, false);

        var iconAlertElement = document.createElement('div');
        iconAlertElement.className = 'ol-unselectable ol-control';
        iconAlertElement.appendChild(iconAlertButton);
        iconAlertElement.style.left = '0.5em';
        iconAlertElement.style.top = '5em';

        var iconAlertDraw = new ol.control.Control({
          element: iconAlertElement
        });
        map.addControl(iconAlertDraw);

        //
        // overlay
        //

        var popup = new Popup();
        map.addOverlay(popup);

        // var container = document.getElementById('popup');
        //
        // var popup = new ol.Overlay({
        //   element: container,
        //   autoPan: true,
        //   autoPanAnimation: {
        //     duration: 250
        //   },
        //   positioning: 'bottom-center',
        //   stopEvent: false,
        // });
        // map.addOverlay(popup);
        //
        // let popover;
        // function disposePopover() {
        //   if (popover) {
        //     popover.dispose();
        //     popover = undefined;
        //   }
        // }
        // display popup on click
        map.on('click', function (evt) {
          const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
            return feature;
          });
          popup.hide();
          if (!feature) {
            return;
          }
          popup.show(evt.coordinate, feature.get('clan'));
          // popover = new bootstrap.Popover(container, {
          //   placement: 'top',
          //   html: true,
          //   content: feature.get('name'),
          // });
          // popover.show();
        });

        //
        // Plugins
        //

        const layerSwitcher = new LayerSwitcher({
          reverse: true,
          groupSelectStyle: 'group'
        });
        map.addControl(layerSwitcher);

    </script>
</body>
</html>